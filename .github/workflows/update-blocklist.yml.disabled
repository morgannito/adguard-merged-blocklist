name: Update AdGuard Blocklist

on:
  schedule:
    # ExÃ©cute tous les jours Ã  06:00 UTC (08:00 heure de Paris en hiver, 07:00 en Ã©tÃ©)
    - cron: '0 6 * * *'
  workflow_dispatch: # Permet de dÃ©clencher manuellement
  push:
    branches: [ main ]
    # DÃ©clenche sur tout push pour activer automatiquement les Actions

jobs:
  update-blocklist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Checkout AdGuard Blocklist Merger
      uses: actions/checkout@v4
      with:
        repository: morgannito/adguard-blocklist-merger
        path: adguard-merger
    
    - name: Install and Build AdGuard Blocklist Merger
      run: |
        cd adguard-merger
        npm install
        npm run build
        npm link
    
    - name: Generate merged blocklist
      run: |
        echo "ğŸš€ GÃ©nÃ©ration de la liste de blocage fusionnÃ©e..."
        
        # CrÃ©er le fichier de configuration
        cat > temp-config.json << 'EOF'
        {
          "urls": [
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adware.txt",
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/antiadblock.txt",
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/general_elemhide.txt",
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/general_extensions.txt",
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/general_url.txt",
            "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts",
            "https://someonewhocares.org/hosts/zero/hosts",
            "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/MobileFilter/sections/adware.txt",
            "https://easylist.to/easylist/easylist.txt",
            "https://easylist.to/easylist/easyprivacy.txt"
          ],
          "githubRepo": "${{ github.repository }}",
          "githubToken": "${{ secrets.GITHUB_TOKEN }}",
          "outputFile": "merged-blocklist.txt",
          "logLevel": "info",
          "timeout": 60000,
          "retries": 3,
          "branch": "main",
          "commitMessage": "ğŸ¤– Mise Ã  jour automatique de la liste de blocage - {{timestamp}}",
          "automationMode": true,
          "skipUnchanged": false
        }
        EOF
        
        # ExÃ©cuter le merger
        adguard-merger --config temp-config.json --automation
        
        # Nettoyer le fichier de config temporaire
        rm temp-config.json
    
    - name: Generate statistics
      run: |
        echo "ğŸ“Š GÃ©nÃ©ration des statistiques..."
        
        if [ -f "merged-blocklist.txt" ]; then
          # Compter les lignes
          TOTAL_LINES=$(wc -l < merged-blocklist.txt)
          RULE_LINES=$(grep -v '^[[:space:]]*$' merged-blocklist.txt | grep -v '^[[:space:]]*!' | wc -l)
          COMMENT_LINES=$(grep '^[[:space:]]*!' merged-blocklist.txt | wc -l)
          FILE_SIZE=$(du -h merged-blocklist.txt | cut -f1)
          
          # CrÃ©er le fichier de statistiques
          cat > stats.json << EOF
        {
          "lastUpdate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "totalLines": $TOTAL_LINES,
          "ruleLines": $RULE_LINES,
          "commentLines": $COMMENT_LINES,
          "fileSize": "$FILE_SIZE",
          "sources": 10
        }
        EOF
          
          echo "âœ… Statistiques gÃ©nÃ©rÃ©es:"
          echo "   - Lignes totales: $TOTAL_LINES"
          echo "   - RÃ¨gles de blocage: $RULE_LINES"
          echo "   - Commentaires: $COMMENT_LINES"
          echo "   - Taille du fichier: $FILE_SIZE"
        else
          echo "âŒ Erreur: Le fichier merged-blocklist.txt n'a pas Ã©tÃ© gÃ©nÃ©rÃ©"
          exit 1
        fi
    
    - name: Update README with stats
      run: |
        echo "ğŸ“ Mise Ã  jour du README avec les statistiques..."
        
        if [ -f "stats.json" ]; then
          # Lire les statistiques
          LAST_UPDATE=$(jq -r '.lastUpdate' stats.json)
          RULE_LINES=$(jq -r '.ruleLines' stats.json)
          FILE_SIZE=$(jq -r '.fileSize' stats.json)
          SOURCES=$(jq -r '.sources' stats.json)
          
          # Formater la date en franÃ§ais
          FORMATTED_DATE=$(date -d "$LAST_UPDATE" "+%d/%m/%Y Ã  %H:%M UTC" 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_UPDATE" "+%d/%m/%Y Ã  %H:%M UTC" 2>/dev/null || echo "$LAST_UPDATE")
          
          # CrÃ©er un badge de statut
          cat > status.md << EOF
        <!-- AUTO-GENERATED STATS - DO NOT EDIT MANUALLY -->
        ## ğŸ“Š Statistiques Actuelles
        
        - **ğŸ“… DerniÃ¨re mise Ã  jour** : $FORMATTED_DATE
        - **ğŸ›¡ï¸ RÃ¨gles de blocage** : $(printf "%'d" $RULE_LINES)
        - **ğŸ“¦ Taille du fichier** : $FILE_SIZE
        - **ğŸ”— Sources traitÃ©es** : $SOURCES
        - **âœ… Statut** : Actif et mis Ã  jour quotidiennement
        
        <!-- END AUTO-GENERATED STATS -->
        EOF
          
          echo "âœ… Statistiques formatÃ©es pour le README"
        fi
    
    - name: Commit and push changes
      run: |
        echo "ğŸ’¾ Commit et push des changements..."
        
        # Configuration Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ajouter les fichiers modifiÃ©s
        git add merged-blocklist.txt stats.json status.md
        
        # VÃ©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "â„¹ï¸ Aucun changement dÃ©tectÃ©, pas de commit nÃ©cessaire"
        else
          # Commit avec un message dÃ©taillÃ©
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– Mise Ã  jour automatique - $TIMESTAMP

        ğŸ“Š Statistiques:
        - RÃ¨gles de blocage: $(jq -r '.ruleLines' stats.json 2>/dev/null || echo 'N/A')
        - Taille: $(jq -r '.fileSize' stats.json 2>/dev/null || echo 'N/A')
        - Sources: $(jq -r '.sources' stats.json 2>/dev/null || echo 'N/A')
        
        ğŸ”„ Mise Ã  jour automatique quotidienne via GitHub Actions"
          
          # Push vers la branche main
          git push origin main
          
          echo "âœ… Changements poussÃ©s vers GitHub"
        fi
    
    - name: Create release (weekly)
      if: github.event.schedule == '0 6 * * 0' # Dimanche seulement
      run: |
        echo "ğŸ·ï¸ CrÃ©ation d'une release hebdomadaire..."
        
        # GÃ©nÃ©rer un tag basÃ© sur la date
        TAG_NAME="v$(date +%Y.%m.%d)"
        
        # CrÃ©er la release
        gh release create "$TAG_NAME" \
          --title "ğŸ“… Release Hebdomadaire - $(date +%d/%m/%Y)" \
          --notes "ğŸ¤– **Mise Ã  jour automatique hebdomadaire**

        ğŸ“Š **Statistiques:**
        - **RÃ¨gles de blocage:** $(jq -r '.ruleLines' stats.json | xargs printf "%'d")
        - **Taille du fichier:** $(jq -r '.fileSize' stats.json)
        - **Sources traitÃ©es:** $(jq -r '.sources' stats.json)
        - **DerniÃ¨re mise Ã  jour:** $(date -d "$(jq -r '.lastUpdate' stats.json)" "+%d/%m/%Y Ã  %H:%M UTC")

        ğŸ”— **Utilisation:**
        \`\`\`
        https://raw.githubusercontent.com/${{ github.repository }}/main/merged-blocklist.txt
        \`\`\`

        ğŸ“‹ **Changements:**
        - Mise Ã  jour automatique de toutes les sources
        - DÃ©duplication et validation des rÃ¨gles
        - Optimisation pour AdGuard Home et Pi-hole" \
          merged-blocklist.txt
        
        echo "âœ… Release crÃ©Ã©e: $TAG_NAME"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Ã‰chec de la mise Ã  jour automatique"
        echo "VÃ©rifiez les logs dans l'onglet Actions de GitHub"
        
        # CrÃ©er un fichier d'erreur pour debugging
        cat > error-log.txt << EOF
        Ã‰chec de la mise Ã  jour automatique
        Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Workflow: ${{ github.workflow }}
        Run ID: ${{ github.run_id }}
        EOF
        
        # Optionnel: Commit le log d'erreur pour debugging
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add error-log.txt
        git commit -m "âŒ Log d'erreur - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || true
        git push origin main || true