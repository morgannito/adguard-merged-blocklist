name: Working Blocklist Update

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-blocklist:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm install axios
    
    - name: Create merge script
      run: |
        cat > merge.js << 'SCRIPT_END'
        const axios = require('axios');
        const fs = require('fs');
        
        const sources = [
          // AdGuard Official Filters
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_1.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_2.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_8.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_9.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_10.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_11.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_12.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_18.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_23.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_30.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_31.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_39.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_42.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_44.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_50.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_52.txt',
          'https://adguardteam.github.io/HostlistsRegistry/assets/filter_54.txt',
          
          // Gaming and Specialized Lists
          'https://raw.githubusercontent.com/Mafraysse/AdGuard_GameList-Filter/main/AdGuard_games_list.txt',
          
          // Security and Threat Protection
          'https://blocklistproject.github.io/Lists/adguard/drugs-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/crypto-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/fraud-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/gambling-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/malware-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/phishing-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/piracy-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/porn-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/ransomware-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/scam-ags.txt',
          'https://blocklistproject.github.io/Lists/adguard/torrent-ags.txt',
          
          // Community and Comprehensive Lists
          'https://content.spiceworksstatic.com/service.community/p/post_attachments/0000175337/58c03a00/attached_file/sites.txt',
          'https://abp.oisd.nl/',
          'https://raw.githubusercontent.com/hagezi/dns-blocklists/refs/heads/main/adblock/ultimate.txt'
        ];
        
        async function fetchSource(url) {
          try {
            console.log('Fetching:', url);
            const response = await axios.get(url, { timeout: 45000 });
            return { url, content: response.data, success: true };
          } catch (error) {
            console.error('Failed:', url, error.message);
            return { url, content: '', success: false };
          }
        }
        
        async function main() {
          console.log('Starting merge...');
          
          const results = await Promise.all(sources.map(fetchSource));
          const successful = results.filter(r => r.success);
          
          console.log('Successful:', successful.length, 'Failed:', results.length - successful.length);
          
          if (successful.length === 0) {
            throw new Error('No sources available');
          }
          
          const header = [
            '! Title: AdGuard Comprehensive Merged Blocklist',
            '! Description: Auto-generated comprehensive blocklist from 33+ premium sources',
            '! Last modified: ' + new Date().toISOString(),
            '! Sources processed: ' + successful.length + '/' + sources.length,
            '! Categories: AdGuard Official, Security, Gaming, Adult Content, Malware, Phishing',
            '! Compatible: AdGuard Home, Pi-hole, uBlock Origin, AdBlock Plus',
            '! Update frequency: Daily at 06:00 UTC',
            '! Repository: https://github.com/morgannito/adguard-merged-blocklist',
            '!'
          ];
          
          let allLines = [...header];
          let totalEntries = 0;
          
          for (const result of successful) {
            const lines = result.content.split('\n')
              .map(line => line.trim())
              .filter(line => line.length > 0);
            
            totalEntries += lines.length;
            allLines.push('');
            allLines.push('! Source: ' + result.url);
            allLines.push(...lines);
          }
          
          // Remove duplicates efficiently
          const seen = new Map();
          const unique = [];
          for (const line of allLines) {
            if (!seen.has(line)) {
              seen.set(line, true);
              unique.push(line);
            }
          }
          const content = unique.join('\n') + '\n';
          
          fs.writeFileSync('merged-blocklist.txt', content);
          
          const stats = {
            lastUpdate: new Date().toISOString(),
            totalLines: unique.length,
            ruleLines: unique.filter(l => l && !l.startsWith('!')).length,
            fileSize: Math.round(content.length / 1024) + 'KB',
            sources: successful.length,
            duplicatesRemoved: allLines.length - unique.length
          };
          
          fs.writeFileSync('stats.json', JSON.stringify(stats, null, 2));
          
          console.log('Stats:', JSON.stringify(stats, null, 2));
          console.log('Merge completed!');
        }
        
        main().catch(error => {
          console.error('Error:', error);
          process.exit(1);
        });
        SCRIPT_END
    
    - name: Run merge script
      run: node merge.js
    
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add merged-blocklist.txt stats.json
        
        if ! git diff --staged --quiet; then
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ðŸ¤– Auto-update $TIMESTAMP"
          git push origin main
          echo "Changes pushed"
        else
          echo "No changes"
        fi
    
    - name: Cleanup
      if: always()
      run: rm -f merge.js